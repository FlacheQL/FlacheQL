{"version":3,"file":"bundle.umd.js","sources":["../src/dedupLink.ts"],"sourcesContent":["import {\n  ApolloLink,\n  Operation,\n  NextLink,\n  FetchResult,\n  Observable,\n} from 'apollo-link';\n\n/*\n * Expects context to contain the forceFetch field if no dedup\n */\nexport class DedupLink extends ApolloLink {\n  private inFlightRequestObservables: Map<\n    string,\n    Observable<FetchResult>\n  > = new Map();\n  private subscribers: Map<string, any> = new Map();\n\n  public request(\n    operation: Operation,\n    forward: NextLink,\n  ): Observable<FetchResult> {\n    // sometimes we might not want to deduplicate a request, for example when we want to force fetch it.\n    if (operation.getContext().forceFetch) {\n      return forward(operation);\n    }\n\n    const key = operation.toKey();\n\n    const cleanup = key => {\n      this.inFlightRequestObservables.delete(key);\n      const prev = this.subscribers.get(key);\n      return prev;\n    };\n\n    if (!this.inFlightRequestObservables.get(key)) {\n      // this is a new request, i.e. we haven't deduplicated it yet\n      // call the next link\n      const singleObserver = forward(operation);\n      let subscription;\n\n      const sharedObserver = new Observable(observer => {\n        // this will still be called by each subscriber regardless of\n        // deduplication status\n        let prev = this.subscribers.get(key);\n        if (!prev) prev = { next: [], error: [], complete: [] };\n\n        this.subscribers.set(key, {\n          next: prev.next.concat([observer.next.bind(observer)]),\n          error: prev.error.concat([observer.error.bind(observer)]),\n          complete: prev.complete.concat([observer.complete.bind(observer)]),\n        });\n\n        if (!subscription) {\n          subscription = singleObserver.subscribe({\n            next: result => {\n              const prev = cleanup(key);\n              this.subscribers.delete(key);\n              if (prev) {\n                prev.next.forEach(next => next(result));\n                prev.complete.forEach(complete => complete());\n              }\n            },\n            error: error => {\n              const prev = cleanup(key);\n              this.subscribers.delete(key);\n              if (prev) prev.error.forEach(err => err(error));\n            },\n          });\n        }\n\n        return () => {\n          if (subscription) subscription.unsubscribe();\n          this.inFlightRequestObservables.delete(key);\n        };\n      });\n\n      this.inFlightRequestObservables.set(key, sharedObserver);\n    }\n\n    // return shared Observable\n    return this.inFlightRequestObservables.get(key);\n  }\n}\n"],"names":["Observable","ApolloLink"],"mappings":"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"}